<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <meta name="keywords" content="Hexo Theme Keep">
    <meta name="description" content="Hexo Theme Keep">
    <meta name="author" content="Shipeng He">
    <meta name="baidu-site-verification" content="code-ALXTDYlBtB" />
    <meta name="google-site-verification" content="code-ALXTDYlBtB" />
    
    <title>
        
            Androidé€†å‘ä¹‹åŠ¨æ€åŠ è½½ |
        
        æ‹¾å…‰çš„é€†ç¾½
    </title>
    
<link rel="stylesheet" href="/css/style.css">

    <link rel="shortcut icon" href="/images/logo.svg">
    <link rel="stylesheet" href="//cdn.jsdelivr.net/npm/hexo-theme-keep@3.4.5/source/css/font-awesome.min.css">
    <script id="hexo-configurations">
    let KEEP = window.KEEP || {};
    KEEP.hexo_config = {"hostname":"example.com","root":"/","language":"zh-CN"};
    KEEP.theme_config = {"toc":{"enable":true,"number":false,"expand_all":true,"init_open":true},"style":{"primary_color":"#0066CC","avatar":"/images/avatar.jpeg","favicon":"/images/logo.svg","article_img_align":"center","left_side_width":"260px","content_max_width":"920px","hover":{"shadow":false,"scale":false},"first_screen":{"enable":true,"background_img":"/images/bg.svg","description":"Keep writing and Keep loving."},"scroll":{"progress_bar":{"enable":true},"percent":{"enable":true}}},"local_search":{"enable":true,"preload":false},"code_copy":{"enable":true,"style":"mac"},"pjax":{"enable":false},"lazyload":{"enable":true},"version":"3.4.5"};
    KEEP.language_ago = {"second":"%s ç§’å‰","minute":"%s åˆ†é’Ÿå‰","hour":"%s å°æ—¶å‰","day":"%s å¤©å‰","week":"%s å‘¨å‰","month":"%s ä¸ªæœˆå‰","year":"%s å¹´å‰"};
  </script>
<meta name="generator" content="Hexo 5.4.0"><style>mjx-container[jax="SVG"] {
  direction: ltr;
}

mjx-container[jax="SVG"] > svg {
  overflow: visible;
}

mjx-container[jax="SVG"][display="true"] {
  display: block;
  text-align: center;
  margin: 1em 0;
}

mjx-container[jax="SVG"][justify="left"] {
  text-align: left;
}

mjx-container[jax="SVG"][justify="right"] {
  text-align: right;
}

g[data-mml-node="merror"] > g {
  fill: red;
  stroke: red;
}

g[data-mml-node="merror"] > rect[data-background] {
  fill: yellow;
  stroke: none;
}

g[data-mml-node="mtable"] > line[data-line] {
  stroke-width: 70px;
  fill: none;
}

g[data-mml-node="mtable"] > rect[data-frame] {
  stroke-width: 70px;
  fill: none;
}

g[data-mml-node="mtable"] > .mjx-dashed {
  stroke-dasharray: 140;
}

g[data-mml-node="mtable"] > .mjx-dotted {
  stroke-linecap: round;
  stroke-dasharray: 0,140;
}

g[data-mml-node="mtable"] > svg {
  overflow: visible;
}

[jax="SVG"] mjx-tool {
  display: inline-block;
  position: relative;
  width: 0;
  height: 0;
}

[jax="SVG"] mjx-tool > mjx-tip {
  position: absolute;
  top: 0;
  left: 0;
}

mjx-tool > mjx-tip {
  display: inline-block;
  padding: .2em;
  border: 1px solid #888;
  font-size: 70%;
  background-color: #F8F8F8;
  color: black;
  box-shadow: 2px 2px 5px #AAAAAA;
}

g[data-mml-node="maction"][data-toggle] {
  cursor: pointer;
}

mjx-status {
  display: block;
  position: fixed;
  left: 1em;
  bottom: 1em;
  min-width: 25%;
  padding: .2em .4em;
  border: 1px solid #888;
  font-size: 90%;
  background-color: #F8F8F8;
  color: black;
}

foreignObject[data-mjx-xml] {
  font-family: initial;
  line-height: normal;
  overflow: visible;
}

.MathJax path {
  stroke-width: 3;
}

mjx-container[display="true"] {
  overflow: auto hidden;
}

mjx-container[display="true"] + br {
  display: none;
}
</style></head>


<body>
<div class="progress-bar-container">
    
        <span class="scroll-progress-bar"></span>
    

    
</div>


<main class="page-container">

    

    <div class="page-main-content">

        <div class="page-main-content-top">
            <header class="header-wrapper">

    <div class="header-content">
        <div class="left">
            
            <a class="logo-title" href="/">
                æ‹¾å…‰çš„é€†ç¾½
            </a>
        </div>

        <div class="right">
            <div class="pc">
                <ul class="menu-list">
                    
                        <li class="menu-item">
                            <a class=""
                               href="/"
                            >
                                é¦–é¡µ
                            </a>
                        </li>
                    
                        <li class="menu-item">
                            <a class=""
                               href="/archives"
                            >
                                å½’æ¡£
                            </a>
                        </li>
                    
                        <li class="menu-item">
                            <a class=""
                               href="/categories"
                            >
                                åˆ†ç±»
                            </a>
                        </li>
                    
                        <li class="menu-item">
                            <a class=""
                               href="/tags"
                            >
                                æ ‡ç­¾
                            </a>
                        </li>
                    
                    
                        <li class="menu-item search search-popup-trigger">
                            <i class="fas fa-search"></i>
                        </li>
                    
                </ul>
            </div>
            <div class="mobile">
                
                    <div class="icon-item search search-popup-trigger"><i class="fas fa-search"></i></div>
                
                <div class="icon-item menu-bar">
                    <div class="menu-bar-middle"></div>
                </div>
            </div>
        </div>
    </div>

    <div class="header-drawer">
        <ul class="drawer-menu-list">
            
                <li class="drawer-menu-item flex-center">
                    <a class=""
                       href="/">é¦–é¡µ</a>
                </li>
            
                <li class="drawer-menu-item flex-center">
                    <a class=""
                       href="/archives">å½’æ¡£</a>
                </li>
            
                <li class="drawer-menu-item flex-center">
                    <a class=""
                       href="/categories">åˆ†ç±»</a>
                </li>
            
                <li class="drawer-menu-item flex-center">
                    <a class=""
                       href="/tags">æ ‡ç­¾</a>
                </li>
            
        </ul>
    </div>

    <div class="window-mask"></div>

</header>


        </div>

        <div class="page-main-content-middle">

            <div class="main-content">

                
                    <div class="fade-in-down-animation">
    <div class="article-content-container">

        <div class="article-title">
            <span class="title-hover-animation">Androidé€†å‘ä¹‹åŠ¨æ€åŠ è½½</span>
        </div>

        
            <div class="article-header">
                <div class="avatar">
                    <img src="/images/avatar.jpeg">
                </div>
                <div class="info">
                    <div class="author">
                        <span class="name">Shipeng He</span>
                        
                            <span class="author-label">é«˜çº§æ”»åŸç‹®</span>
                        
                    </div>
                    <div class="meta-info">
                        <div class="article-meta-info">
    <span class="article-date article-meta-item">
        <i class="fas fa-edit"></i>&nbsp;
        <span class="pc">2022-01-15 23:40:22</span>
        <span class="mobile">2022-01-15 23:40</span>
    </span>
    
        <span class="article-categories article-meta-item">
            <i class="fas fa-folder"></i>&nbsp;
            <ul>
                
                    <li>
                        <a href="/categories/Android/">Android</a>&nbsp;
                    </li>
                
            </ul>
        </span>
    
    
        <span class="article-tags article-meta-item">
            <i class="fas fa-tags"></i>&nbsp;
            <ul>
                
                    <li>
                        <a href="/tags/%E9%80%86%E5%90%91/">é€†å‘</a>&nbsp;
                    </li>
                
                    <li>
                        | <a href="/tags/android/">android</a>&nbsp;
                    </li>
                
            </ul>
        </span>
    

    
    
    
    
        <span class="article-pv article-meta-item">
            <i class="fas fa-eye"></i>&nbsp;<span id="busuanzi_value_page_pv"></span>
        </span>
    
</div>

                    </div>
                </div>
            </div>
        

        <div class="article-content markdown-body">
            <div align="middle"><iframe width="560" height="315" src="https://www.youtube.com/embed/k7akz2hdToY" title="YouTube video player" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe></div>



<h3 id="åŠ¨æ€åŠ è½½"><a href="#åŠ¨æ€åŠ è½½" class="headerlink" title="åŠ¨æ€åŠ è½½"></a>åŠ¨æ€åŠ è½½</h3><p>å¼€å§‹æ­£é¢˜ä¹‹å‰ï¼Œåœ¨è¿™é‡Œå¯ä»¥å…ˆç»™åŠ¨æ€åŠ è½½æŠ€æœ¯åšä¸€ä¸ªç®€å•çš„å®šä¹‰ã€‚çœŸæ­£çš„åŠ¨æ€åŠ è½½åº”è¯¥æ˜¯</p>
<ol>
<li>åº”ç”¨åœ¨è¿è¡Œçš„æ—¶å€™é€šè¿‡åŠ è½½ä¸€äº›<strong>æœ¬åœ°ä¸å­˜åœ¨</strong>çš„å¯æ‰§è¡Œæ–‡ä»¶å®ç°ä¸€äº›ç‰¹å®šçš„åŠŸèƒ½ã€‚</li>
<li>è¿™äº›å¯æ‰§è¡Œæ–‡ä»¶æ˜¯<strong>å¯ä»¥æ›¿æ¢</strong>çš„ã€‚</li>
<li>æ›´æ¢é™æ€èµ„æº(æ¯”å¦‚æ¢å¯åŠ¨å›¾ã€æ¢ä¸»é¢˜ã€æˆ–è€…ç”¨æœåŠ¡å™¨å‚æ•°å¼€å…³æ§åˆ¶å¹¿å‘Šçš„éšè—ç°å®ç­‰)<strong>ä¸å±äº</strong>åŠ¨æ€åŠ è½½ã€‚</li>
<li><code>Android</code>ä¸­åŠ¨æ€åŠ è½½çš„æ ¸å¿ƒæ€æƒ³æ˜¯åŠ¨æ€è°ƒç”¨å¤–éƒ¨çš„ <strong><code>dex</code>æ–‡ä»¶</strong>ï¼Œæç«¯çš„æƒ…å†µä¸‹ï¼Œ<code>Android APK</code>è‡ªèº«å¸¦æœ‰çš„<code>Dex</code>æ–‡ä»¶åªæ˜¯ä¸€ä¸ªç¨‹åºçš„å…¥å£(æˆ–è€…è¯´ç©ºå£³)ï¼Œæ‰€æœ‰çš„åŠŸèƒ½éƒ½é€šè¿‡ä»æœåŠ¡å™¨ä¸‹è½½æœ€æ–°çš„<code>Dex</code>æ–‡ä»¶å®Œæˆã€‚</li>
</ol>
<h3 id="ä¸¤ä¸ªç–‘é—®ğŸ¤”"><a href="#ä¸¤ä¸ªç–‘é—®ğŸ¤”" class="headerlink" title="ä¸¤ä¸ªç–‘é—®ğŸ¤”"></a>ä¸¤ä¸ªç–‘é—®ğŸ¤”</h3><p>æå‡ºä¸¤ä¸ªé—®é¢˜ï¼Œç¬¬ä¸€ï¼Œå¦‚ä½•åœ¨<code>Android</code>ç¨‹åºä¸­åŠ è½½å¤–éƒ¨<code>dex</code>çš„<code>class</code>ï¼›ç¬¬äºŒï¼Œå¯¹äºæœ‰ç”Ÿå‘½å‘¨æœŸçš„ç»„ä»¶(æ¯”å¦‚Activityè¿™ç§ç±»)è¯¥å¦‚ä½•åŠ è½½ï¼Ÿæœ¬æ–‡çš„ç›®çš„å°±æ˜¯é€šè¿‡è§£å†³è¿™2ä¸ªé—®é¢˜ä»è€Œå¯¹<code>Android</code>çš„åŠ¨æ€åŠ è½½æŠ€æœ¯æœ‰ä¸€å®šçš„äº†è§£ã€‚</p>
<h3 id="ç±»åŠ è½½å™¨ä¸åŒäº²å§”æ´¾"><a href="#ç±»åŠ è½½å™¨ä¸åŒäº²å§”æ´¾" class="headerlink" title="ç±»åŠ è½½å™¨ä¸åŒäº²å§”æ´¾"></a>ç±»åŠ è½½å™¨ä¸åŒäº²å§”æ´¾</h3><p>è¦è§£å†³è¿™ä¿©é—®é¢˜ï¼Œé¦–å…ˆè¦äº†è§£å‡ ä¸ªæ¦‚å¿µã€‚</p>
<h4 id="ç±»åŠ è½½å™¨"><a href="#ç±»åŠ è½½å™¨" class="headerlink" title="ç±»åŠ è½½å™¨"></a>ç±»åŠ è½½å™¨</h4><p>ç±»åŠ è½½å™¨é¡¾åæ€ä¹‰æ˜¯ç”¨æ¥è¿›è¡Œç±»çš„åŠ è½½ã€‚åˆ†åˆ«çœ‹ä¸‹JVMçš„ç±»åŠ è½½å™¨å’ŒAndroidçš„ç±»åŠ è½½å™¨ã€‚</p>
<h5 id="JVMçš„ç±»åŠ è½½å™¨"><a href="#JVMçš„ç±»åŠ è½½å™¨" class="headerlink" title="JVMçš„ç±»åŠ è½½å™¨"></a>JVMçš„ç±»åŠ è½½å™¨</h5><p>JVMçš„ç±»åŠ è½½å™¨åŒ…æ‹¬3ç§ï¼š</p>
<ol>
<li>Bootstrap ClassLoader(å¼•å¯¼ç±»åŠ è½½å™¨)</li>
</ol>
<p>C/C++ä»£ç å®ç°çš„åŠ è½½å™¨ï¼Œç”¨äºåŠ è½½æŒ‡å®šçš„JDKçš„æ ¸å¿ƒç±»åº“ï¼Œæ¯”å¦‚java.langï¼Œjava.utilç­‰è¿™äº›ç³»ç»Ÿç±»ã€‚Javaè™šæ‹Ÿæœºçš„å¯åŠ¨å°±æ˜¯é€šè¿‡Bootstrapï¼Œè¯¥Classloaderåœ¨javaé‡Œæ— æ³•è·å–ï¼Œè´Ÿè´£åŠ è½½/libä¸‹çš„ç±»ã€‚</p>
<ol start="2">
<li>Extensions ClassLoader(æ‹“å±•ç±»åŠ è½½å™¨)</li>
</ol>
<p>Javaä¸­çš„å®ç°ç±»ä¸ºExtClassLoaderï¼Œæä¾›äº†é™¤äº†ç³»ç»Ÿç±»ä¹‹å¤–çš„é¢å¤–åŠŸèƒ½ï¼Œå¯ä»¥åœ¨Javaé‡Œè·å–ï¼Œè´Ÿè´£åŠ è½½/lib/extä¸‹çš„ç±»ã€‚</p>
<ol start="3">
<li>Application ClassLoader(åº”ç”¨ç¨‹åºç±»åŠ è½½å™¨)</li>
</ol>
<p>Javaä¸­çš„å®ç°ç±»ä¸ºAppClassLoaderï¼Œæ˜¯ä¸æˆ‘ä»¬æ¥è§¦æœ€å¤šçš„ç±»åŠ è½½å™¨ï¼Œå¼€å‘äººå‘˜å†™çš„ä»£ç é»˜è®¤å°±æ˜¯ç”±å®ƒæ¥åŠ è½½ï¼ŒClassLoader.getSystemCLassLoaderè¿”å›çš„å°±æ˜¯å®ƒã€‚</p>
<p>åŒæ—¶ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥è‡ªå®šä¹‰ç±»åŠ è½½å™¨ï¼Œåªéœ€è¦é€šè¿‡ç»§æ‰¿java.lang.ClassLoaderç±»çš„æ–¹å¼æ¥å®ç°è‡ªå·±çš„ç±»åŠ è½½å™¨å³å¯ã€‚</p>
<h5 id="Androidä¸­çš„ç±»åŠ è½½å™¨"><a href="#Androidä¸­çš„ç±»åŠ è½½å™¨" class="headerlink" title="Androidä¸­çš„ç±»åŠ è½½å™¨"></a>Androidä¸­çš„ç±»åŠ è½½å™¨</h5><p>é¦–å…ˆé€šè¿‡ä¸€å¼ å›¾ï¼Œäº†è§£å„ä¸ªåŠ è½½å™¨ä¹‹é—´çš„ç»§æ‰¿å…³ç³»ã€‚</p>
<p><img lazyload="" src="/images/loading.svg" data-src="https://img.heshipeng.com/202201131046618.png?watermark/2/text/5YWz5rOo5b6u5L-h5YWs5LyX5Y-377ya6YCG5ZCR5LiA5q2l5q2l/font/5a6L5L2T/fontsize/300" alt="image"></p>
<p>è¯¦ç»†çœ‹ä¸‹å„ä¸ªç±»åŠ è½½å™¨çš„ä½œç”¨ï¼š</p>
<ol>
<li><p>ClassLoaderä¸ºæŠ½è±¡ç±»ï¼›</p>
</li>
<li><p>BootClassLoaderé¢„åŠ è½½å¸¸ç”¨ç±»ï¼Œå•ä¾‹æ¨¡å¼ã€‚ä¸Javaä¸­çš„BootClassLoaderä¸åŒï¼Œå®ƒå¹¶ä¸æ˜¯ç”±C/C++ä»£ç å®ç°ï¼Œè€Œæ˜¯ç”±Javaå®ç°çš„ï¼›</p>
</li>
<li><p>BaseDexClassLoaderæ˜¯PathClassLoader, DexClassLoader, InMemoryDexClassLoaderçš„çˆ¶ç±»ï¼Œç±»åŠ è½½çš„ä¸»è¦é€»è¾‘éƒ½æ˜¯åœ¨BaseDexClassLoaderå®Œæˆçš„ï¼›</p>
</li>
<li><p>SecureClassLoaderç»§æ‰¿äº†æŠ½è±¡ç±»ClassLoaderï¼Œæ‹“å±•äº†ClassLoaderç±»åŠ å…¥äº†æƒé™æ–¹é¢çš„åŠŸèƒ½ï¼ŒåŠ å¼ºäº†å®‰å…¨æ€§ï¼Œå…¶å­ç±»URLClassLoaderæ˜¯ç”¨URLè·¯å¾„ä»jaræ–‡ä»¶ä¸­åŠ è½½ç±»å’Œèµ„æºã€‚</p>
</li>
<li><p>PathClassLoaderæ˜¯Androidé»˜è®¤ä½¿ç”¨çš„ç±»åŠ è½½å™¨ï¼Œä¸€ä¸ªapkä¸­çš„Activityç­‰ç±»ä¾¿æ˜¯åœ¨å…¶ä¸­åŠ è½½ã€‚</p>
</li>
<li><p>DexClassLoaderå¯ä»¥åŠ è½½ä»»æ„ç›®å½•ä¸‹çš„dex/jar/apk/zipæ–‡ä»¶ï¼Œæ¯”PathClassLoaderæ›´çµæ´»ï¼Œæ˜¯å®ç°æ’ä»¶åŒ–ï¼Œçƒ­ä¿®å¤ä»¥åŠdexåŠ å£³çš„é‡ç‚¹ã€‚</p>
</li>
<li><p>InMemoryDexClassLoaderæ˜¯8.0å¼•å…¥çš„ï¼Œæ˜¯ç”¨äºç›´æ¥ä»å†…å­˜ä¸­åŠ è½½dexã€‚</p>
</li>
</ol>
<p>å…¶ä¸­é‡ç‚¹å…³æ³¨çš„æ˜¯ï¼šPathClassLoaderå’ŒDexClassLoaderï¼Œå› ä¸ºè¿™2ä¸ªç±»åŠ è½½å™¨æ˜¯æˆ‘ä»¬è§£å†³ä¸Šé¢2ä¸ªé—®é¢˜çš„å…³é”®ï¼Œä¹Ÿæ˜¯è¿™ä¸ªåŠ¨æ€åŠ è½½ä¸­éå¸¸é‡è¦çš„çš„ç±»åŠ è½½å™¨ã€‚</p>
<h5 id="ç±»åŠ è½½çš„æ—¶æœº"><a href="#ç±»åŠ è½½çš„æ—¶æœº" class="headerlink" title="ç±»åŠ è½½çš„æ—¶æœº"></a>ç±»åŠ è½½çš„æ—¶æœº</h5><ol>
<li>éšå¼åŠ è½½ã€‚</li>
</ol>
<ul>
<li>åˆ›å»ºç±»çš„å®ä¾‹ã€‚</li>
<li>è®¿é—®ç±»çš„é™æ€å˜é‡ï¼Œæˆ–è€…ä¸ºé™æ€å˜é‡èµ‹å€¼ã€‚</li>
<li>è°ƒç”¨ç±»çš„é™æ€æ–¹æ³•ã€‚</li>
<li>ä½¿ç”¨åå°„æ–¹å¼æ¥å¼ºåˆ¶åˆ›å»ºæŸä¸ªç±»æˆ–è€…æ¥å£å¯¹åº”çš„java.lang.Classå¯¹è±¡ã€‚</li>
</ul>
<ol start="2">
<li>æ˜¾å¼åŠ è½½ã€‚</li>
</ol>
<ul>
<li>ä½¿ç”¨LoadClass()åŠ è½½ã€‚</li>
<li>ä½¿ç”¨forName()åŠ è½½ã€‚</li>
</ul>
<h5 id="ç±»åŠ è½½çš„æ­¥éª¤"><a href="#ç±»åŠ è½½çš„æ­¥éª¤" class="headerlink" title="ç±»åŠ è½½çš„æ­¥éª¤"></a>ç±»åŠ è½½çš„æ­¥éª¤</h5><ol>
<li><p>è£…è½½ã€‚æŸ¥æ‰¾å’Œå¯¼å…¥Classæ–‡ä»¶ã€‚</p>
</li>
<li><p>é“¾æ¥ã€‚å…¶ä¸­è§£ææ­¥éª¤æ˜¯å¯ä»¥é€‰æ‹©çš„ã€‚</p>
</li>
<li><ul>
<li>æ£€æŸ¥ï¼šæ£€æŸ¥è½½å…¥çš„classæ–‡ä»¶æ•°æ®çš„æ­£ç¡®æ€§ã€‚</li>
<li>å‡†å¤‡ï¼šç»™ç±»çš„é™æ€å˜é‡åˆ†é…å­˜å‚¨ç©ºé—´ã€‚</li>
<li>è§£æï¼šå°†ç¬¦å·å¼•ç”¨è½¬æ¢æˆç›´æ¥å¼•ç”¨ã€‚</li>
</ul>
</li>
<li><p>åˆå§‹åŒ–ï¼šå³è°ƒç”¨<clinit>å‡½æ•°ï¼Œå¯¹é™æ€å˜é‡ï¼Œé™æ€ä»£ç å—æ‰§è¡Œåˆå§‹åŒ–å·¥ä½œã€‚</clinit></p>
</li>
</ol>
<p><img lazyload="" src="/images/loading.svg" data-src="https://img.heshipeng.com/202201131057328.png?watermark/2/text/5YWz5rOo5b6u5L-h5YWs5LyX5Y-377ya6YCG5ZCR5LiA5q2l5q2l/font/5a6L5L2T/fontsize/300" alt="image"></p>
<h5 id="ç¼–å†™ä»£ç æµ‹è¯•Android-ClassLoaderçš„ç»§æ‰¿å…³ç³»"><a href="#ç¼–å†™ä»£ç æµ‹è¯•Android-ClassLoaderçš„ç»§æ‰¿å…³ç³»" class="headerlink" title="ç¼–å†™ä»£ç æµ‹è¯•Android ClassLoaderçš„ç»§æ‰¿å…³ç³»"></a>ç¼–å†™ä»£ç æµ‹è¯•Android ClassLoaderçš„ç»§æ‰¿å…³ç³»</h5><p>åŠ¨æ‰‹ä¹‹å‰å…ˆé€šè¿‡<a class="link" target="_blank" rel="noopener" href="http://androidxref.com/">Androidæºç é˜…è¯»ç½‘ç«™<i class="fas fa-external-link-alt"></i></a>ï¼Œçœ‹ä¸‹ClassLoaderçš„æºç ï¼š</p>
<p><img lazyload="" src="/images/loading.svg" data-src="https://img.heshipeng.com/202201131124371.png?watermark/2/text/5YWz5rOo5b6u5L-h5YWs5LyX5Y-377ya6YCG5ZCR5LiA5q2l5q2l/font/5a6L5L2T/fontsize/300" alt="android ClassLoaderç±»æºç "></p>
<p>æ‰“å¼€AndroidXRefï¼ŒDefinitionå¡«å†™<code>ClassLoader</code>ï¼Œæœç´¢åŒ…ä½ç½®<code>libcore</code>ï¼Œå¦‚æœä¸ç¡®å®šä½ç½®ï¼Œå¯ä»¥é€‰ä¸­å…¨éƒ¨ï¼Œåªä¸è¿‡æœç´¢å‡ºæ¥çš„ç»“æœä¸æ¯”è¾ƒå¤šï¼Œç­›é€‰èµ·æ¥éº»çƒ¦ä¸€äº›ã€‚æœç´¢å‡ºæ¥ä¸€ä¸ªClassLoader.javaæ–‡ä»¶ï¼Œç‚¹å‡»è¿›å…¥ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">ClassLoader</span> </span>{</span><br><span class="line">    <span class="comment">// çœç•¥</span></span><br><span class="line">  </span><br><span class="line">    <span class="comment">// The parent class loader for delegation</span></span><br><span class="line">    <span class="comment">// Note: VM hardcoded the offset of this field, thus all new fields</span></span><br><span class="line">    <span class="comment">// must be added *after* it.</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ClassLoader parent;</span><br><span class="line">  </span><br><span class="line">  	<span class="meta">@CallerSensitive</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> ClassLoader <span class="title">getParent</span><span class="params">()</span> </span>{</span><br><span class="line">        <span class="keyword">return</span> parent;</span><br><span class="line">    }</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// çœç•¥ </span></span><br><span class="line">}    </span><br></pre></td></tr></table></figure>

<p>è¿™é‡Œå…³æ³¨ä¸€ä¸ªå±æ€§å’Œä¸€ä¸ªæˆå‘˜æ–¹æ³•ï¼Œé€šè¿‡ç»„åˆå…³ç³»parentæ¥æ ‡è¯†æ¯ä¸€ä¸ªClassLoaderçš„çˆ¶äº²ï¼Œè¿™ä¸ªparentæ˜¯å®ç°åŒäº²å§”æ´¾çš„å…³é”®ï¼Œè°ƒç”¨getParentæˆå‘˜æ–¹æ³•åˆ™å¯ä»¥è·å–åˆ°parentå±æ€§ã€‚</p>
<p>çœ‹äº†è¿™ä¹ˆå¤šç†è®ºï¼Œæ²¡æœ‰åŠ¨æ‰‹codingå»å®è·µï¼Œæœ‰ä¸€ç‚¹æ¯ç‡¥ï¼Œæ¥ä¸‹æ¥ç¼–å†™ä¸€ä¸ªdemoå»æµ‹è¯•ä¸€ä¸‹Androidçš„ClassLoaderä¹‹é—´çš„ç»§æ‰¿å…³ç³»ã€‚</p>
<p>æ–°å»ºä¸€ä¸ªé¡¹ç›®ClassLoaderTestï¼Œç„¶åç¼–ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.classloadertest;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> androidx.appcompat.app.AppCompatActivity;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> android.content.Context;</span><br><span class="line"><span class="keyword">import</span> android.os.Bundle;</span><br><span class="line"><span class="keyword">import</span> android.util.Log;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MainActivity</span> <span class="keyword">extends</span> <span class="title">AppCompatActivity</span> </span>{</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(Bundle savedInstanceState)</span> </span>{</span><br><span class="line">        <span class="keyword">super</span>.onCreate(savedInstanceState);</span><br><span class="line">        setContentView(R.layout.activity_main);</span><br><span class="line"></span><br><span class="line">        testClassLoader();</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testClassLoader</span><span class="params">()</span> </span>{</span><br><span class="line">        <span class="comment">// è·å–å½“å‰çš„ClassLoader</span></span><br><span class="line">        Context context = getApplicationContext();</span><br><span class="line">        ClassLoader thisClassLoader = context.getClassLoader();</span><br><span class="line">        <span class="comment">// æˆ–è€…ä½¿ç”¨ä¸‹é¢è¿™ç§æ–¹å¼ï¼š</span></span><br><span class="line">        <span class="comment">// ClassLoader thisClassLoader = MainActivity.class.getClassLoader();</span></span><br><span class="line">        Log.i(<span class="string">"kanxue"</span>, <span class="string">"thisClassLoader:"</span> + thisClassLoader);</span><br><span class="line">        ClassLoader tmpClassLoader = <span class="keyword">null</span>;</span><br><span class="line">        ClassLoader parentClassLoader = thisClassLoader.getParent();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// å‘ä¸Šéå†classLoader</span></span><br><span class="line">        <span class="keyword">while</span> (parentClassLoader != <span class="keyword">null</span>) {</span><br><span class="line">            Log.i(<span class="string">"kanxue"</span>, <span class="string">"this:"</span> + thisClassLoader + <span class="string">", parent:"</span> + parentClassLoader);</span><br><span class="line">            tmpClassLoader = parentClassLoader.getParent();</span><br><span class="line">            thisClassLoader = parentClassLoader;</span><br><span class="line">            parentClassLoader = tmpClassLoader;</span><br><span class="line">        }</span><br><span class="line">        Log.i(<span class="string">"kanxue"</span>, <span class="string">"root:"</span> + thisClassLoader);</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></table></figure>

<p>ä»£ç æ¯”è¾ƒç®€å•ï¼Œè¿™é‡Œä¹Ÿæ˜¯ç›´æ¥ç”¨äº†ä¸Šé¢æºç åˆ†æçš„getParentæ–¹æ³•ï¼Œé€šè¿‡getParentæ–¹æ³•æ‹¿åˆ°parentï¼Œç„¶åä¸€å±‚å±‚çš„å‘ä¸Šéå†ï¼Œä»è€Œæµ‹è¯•å‡ºå„ä¸ªClassLoaderçš„ç»§æ‰¿å…³ç³»ã€‚</p>
<p>æ‰§è¡Œç»“æœå¦‚ä¸‹ï¼š</p>
<p><img lazyload="" src="/images/loading.svg" data-src="https://img.heshipeng.com/202201131142562.png?watermark/2/text/5YWz5rOo5b6u5L-h5YWs5LyX5Y-377ya6YCG5ZCR5LiA5q2l5q2l/font/5a6L5L2T/fontsize/300" alt="image"></p>
<h4 id="åŒäº²å§”æ´¾"><a href="#åŒäº²å§”æ´¾" class="headerlink" title="åŒäº²å§”æ´¾"></a>åŒäº²å§”æ´¾</h4><h5 id="åŒäº²å§”æ´¾çš„å·¥ä½œåŸç†"><a href="#åŒäº²å§”æ´¾çš„å·¥ä½œåŸç†" class="headerlink" title="åŒäº²å§”æ´¾çš„å·¥ä½œåŸç†"></a>åŒäº²å§”æ´¾çš„å·¥ä½œåŸç†</h5><p>å¦‚æœä¸€ä¸ªç±»åŠ è½½å™¨æ”¶åˆ°äº†ç±»åŠ è½½è¯·æ±‚ï¼Œå®ƒå¹¶ä¸ä¼šè‡ªå·±å…ˆå»åŠ è½½ï¼Œè€Œæ˜¯æŠŠè¿™ä¸ªè¯·æ±‚å§”æ´¾ç»™çˆ¶ç±»çš„åŠ è½½å™¨å»æ‰§è¡Œï¼Œå¦‚æœçˆ¶ç±»åŠ è½½å™¨è¿˜å­˜åœ¨å…¶çˆ¶ç±»åŠ è½½å™¨ï¼Œåˆ™è¿›ä¸€æ­¥å‘ä¸Šå§”æ‰˜ï¼Œä¾æ¬¡é€’å½’ï¼Œè¯·æ±‚æœ€ç»ˆå°†åˆ°è¾¾é¡¶å±‚çš„å¯åŠ¨ç±»åŠ è½½å™¨ï¼Œå¦‚æœçˆ¶ç±»åŠ è½½å™¨å¯ä»¥å®Œæˆç±»åŠ è½½ä»»åŠ¡ï¼Œå°±æˆåŠŸè¿”å›ï¼Œå€˜è‹¥çˆ¶ç±»åŠ è½½å™¨æ— æ³•å®Œæˆæ­¤åŠ è½½ä»»åŠ¡ï¼Œå­åŠ è½½å™¨æ‰ä¼šå°è¯•è‡ªå·±å»åŠ è½½ï¼Œè¿™å°±æ˜¯åŒäº²å§”æ´¾æ¨¡å¼ï¼Œå³æ¯ä¸ªå„¿å­éƒ½ä¸æ„¿æ„å¹²æ´»ï¼Œæ¯æ¬¡æœ‰æ´»å°±ä¸¢ç»™çˆ¶äº²å»å¹²ï¼Œç›´åˆ°çˆ¶äº²è¯´è¿™ä»¶äº‹ä¹Ÿå¹²ä¸äº†æ—¶ï¼Œå„¿å­è‡ªå·±æƒ³åŠæ³•å»å®Œæˆï¼Œè¿™å°±æ˜¯åŒäº²å§”æ´¾ã€‚</p>
<p><img lazyload="" src="/images/loading.svg" data-src="https://img.heshipeng.com/202201131058935.png?watermark/2/text/5YWz5rOo5b6u5L-h5YWs5LyX5Y-377ya6YCG5ZCR5LiA5q2l5q2l/font/5a6L5L2T/fontsize/300" alt="image"></p>
<h5 id="ä¸ºä»€ä¹ˆä¼šæœ‰åŒäº²å§”æ´¾"><a href="#ä¸ºä»€ä¹ˆä¼šæœ‰åŒäº²å§”æ´¾" class="headerlink" title="ä¸ºä»€ä¹ˆä¼šæœ‰åŒäº²å§”æ´¾"></a>ä¸ºä»€ä¹ˆä¼šæœ‰åŒäº²å§”æ´¾</h5><ol>
<li>é¿å…é‡å¤åŠ è½½ï¼Œå¦‚æœå·²ç»åŠ è½½è¿‡ä¸€æ¬¡Classï¼Œå¯ä»¥ç›´æ¥è¯»å–å·²ç»åŠ è½½çš„Class</li>
<li>æ›´åŠ å®Œå…¨ï¼Œæ— æ³•è‡ªå®šä¹‰ç±»æ¥ä»£æ›¿ç³»ç»Ÿçš„ç±»ï¼Œå¯ä»¥é˜²æ­¢æ ¸å¿ƒAPIåº“è¢«éšæ„ç¯¡æ”¹ã€‚</li>
</ol>
<h3 id="è§£å†³ç¬¬ä¸€ä¸ªé—®é¢˜"><a href="#è§£å†³ç¬¬ä¸€ä¸ªé—®é¢˜" class="headerlink" title="è§£å†³ç¬¬ä¸€ä¸ªé—®é¢˜"></a>è§£å†³ç¬¬ä¸€ä¸ªé—®é¢˜</h3><p>é€šè¿‡å‰é¢çš„ç†è®ºçŸ¥è¯†ï¼Œæˆ‘ä»¬çŸ¥é“äº†DexClassLoaderå¯ä»¥åŠ è½½ä»»æ„ç›®å½•ä¸‹çš„dex/jar/apk/zipæ–‡ä»¶ï¼Œæ‰€ä»¥æˆ‘ä»¬å…ˆæ¥è§£å†³ç¬¬ä¸€ä¸ªé—®é¢˜ã€‚</p>
<ol>
<li>ç”Ÿæˆä¸€ä¸ªç”¨æ¥æµ‹è¯•çš„dexæ–‡ä»¶ã€‚</li>
</ol>
<p>åˆ›å»ºé¡¹ç›®<code>DexLoaderTest</code>ï¼Œç„¶åæ–°å»ºClassï¼š<code>TestCLass</code>ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.dexloadertest;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> android.util.Log;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TestClass</span> </span>{</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testFunc</span><span class="params">()</span> </span>{</span><br><span class="line">        Log.i(<span class="string">"kanxue"</span>, <span class="string">"call from DexLoaderTest.TestClass.testFunc"</span>);</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></table></figure>

<p>ä»£ç æ¯”è¾ƒç®€å•ï¼Œåªæ˜¯ç®€å•çš„æ‰“å°äº†ä¸€æ¡æ—¥å¿—ã€‚</p>
<p>æ¥ç€ï¼Œæ‰“åŒ…è¯¥é¡¹ç›®ï¼Œå°†ç”Ÿæˆçš„apkè§£å‹ï¼Œå¾—åˆ°dexæ–‡ä»¶(å¦‚æœè§£å‹å¾—åˆ°å¤šä¸ªclasses.dexæ–‡ä»¶ï¼ŒæŸ¥çœ‹ä¸‹æˆ‘ä»¬ç¼–å†™çš„TestClassç±»åœ¨å“ªä¸ªclasses.dexæ–‡ä»¶)ï¼Œç„¶åå°†è¿™ä¸ªclasses.dexæ”¾åˆ°æ‰‹æœºçš„å†…å­˜å¡ï¼š</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">adb push classes.dex /sdcard/</span><br></pre></td></tr></table></figure>



<ol start="2">
<li>åŠ è½½sdcardä¸Šçš„dex</li>
</ol>
<p>ä¿®æ”¹<code>DexLoaderTest</code>ï¼Œä¿®æ”¹å…¶<code>MainActivity</code>çš„ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.dexloadertest;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> androidx.appcompat.app.AppCompatActivity;</span><br><span class="line"><span class="keyword">import</span> android.content.Context;</span><br><span class="line"><span class="keyword">import</span> android.os.Bundle;</span><br><span class="line"><span class="keyword">import</span> android.os.Environment;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.File;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.InvocationTargetException;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Method;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> dalvik.system.DexClassLoader;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MainActivity</span> <span class="keyword">extends</span> <span class="title">AppCompatActivity</span> </span>{</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(Bundle savedInstanceState)</span> </span>{</span><br><span class="line">        <span class="keyword">super</span>.onCreate(savedInstanceState);</span><br><span class="line">        setContentView(R.layout.activity_main);</span><br><span class="line">        String sdcardPath = Environment.getExternalStorageDirectory().getAbsolutePath();</span><br><span class="line">        dexClassLoaderTest(getApplicationContext(), sdcardPath + File.separator + <span class="string">"classes.dex"</span>);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">dexClassLoaderTest</span><span class="params">(Context context, String dexFilePath)</span> </span>{</span><br><span class="line">        Class&lt;?&gt; clazz;</span><br><span class="line">        <span class="keyword">try</span> {</span><br><span class="line">            DexClassLoader dexClassLoader = <span class="keyword">new</span> DexClassLoader(dexFilePath, <span class="keyword">null</span>, <span class="keyword">null</span>, MainActivity.class.getClassLoader());</span><br><span class="line">            clazz = dexClassLoader.loadClass(<span class="string">"com.example.dexclass.TestClass"</span>);</span><br><span class="line">            <span class="keyword">if</span> (clazz != <span class="keyword">null</span>) {</span><br><span class="line">                Method testFuncMethod = clazz.getDeclaredMethod(<span class="string">"testFunc"</span>);</span><br><span class="line">                Object obj = clazz.newInstance();</span><br><span class="line">                testFuncMethod.invoke(obj);</span><br><span class="line">            }</span><br><span class="line">        } <span class="keyword">catch</span> (ClassNotFoundException | NoSuchMethodException e) {</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        } <span class="keyword">catch</span> (IllegalAccessException e) {</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        } <span class="keyword">catch</span> (InstantiationException | InvocationTargetException e) {</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></table></figure>

<p>ä»£ç ä¹Ÿä¸å¤æ‚ï¼Œé¦–å…ˆå®ä¾‹åŒ–ä¸€ä¸ªDexClassLoaderå¯¹è±¡ï¼Œç„¶åé€šè¿‡è¿™ä¸ªå¯¹è±¡åŠ è½½TestClassç±»ï¼Œç„¶åæ‹¿åˆ°testFuncæ–¹æ³•ï¼Œæœ€åé€šè¿‡åå°„è°ƒç”¨è¿™ä¸ªæ–¹æ³•ã€‚è¿™é‡Œä¸»è¦å…³æ³¨çš„æ˜¯DexClassLoaderè¿™ä¸ªç±»ï¼Œæˆ‘ä»¬æŸ¥çœ‹ä¸‹æºç ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DexClassLoader</span> <span class="keyword">extends</span> <span class="title">BaseDexClassLoader</span> </span>{</span><br><span class="line"><span class="number">36</span>    <span class="comment">/**</span></span><br><span class="line"><span class="comment">37     * Creates a {<span class="doctag">@code</span> DexClassLoader} that finds interpreted and native</span></span><br><span class="line"><span class="comment">38     * code.  Interpreted classes are found in a set of DEX files contained</span></span><br><span class="line"><span class="comment">39     * in Jar or APK files.</span></span><br><span class="line"><span class="comment">40     *</span></span><br><span class="line"><span class="comment">41     * &lt;p&gt;The path lists are separated using the character specified by the</span></span><br><span class="line"><span class="comment">42     * {<span class="doctag">@code</span> path.separator} system property, which defaults to {<span class="doctag">@code</span> :}.</span></span><br><span class="line"><span class="comment">43     *</span></span><br><span class="line"><span class="comment">44     * <span class="doctag">@param</span> dexPath the list of jar/apk files containing classes and</span></span><br><span class="line"><span class="comment">45     *     resources, delimited by {<span class="doctag">@code</span> File.pathSeparator}, which</span></span><br><span class="line"><span class="comment">46     *     defaults to {<span class="doctag">@code</span> ":"} on Android</span></span><br><span class="line"><span class="comment">47     * <span class="doctag">@param</span> optimizedDirectory this parameter is deprecated and has no effect since API level 26.</span></span><br><span class="line"><span class="comment">48     * <span class="doctag">@param</span> librarySearchPath the list of directories containing native</span></span><br><span class="line"><span class="comment">49     *     libraries, delimited by {<span class="doctag">@code</span> File.pathSeparator}; may be</span></span><br><span class="line"><span class="comment">50     *     {<span class="doctag">@code</span> null}</span></span><br><span class="line"><span class="comment">51     * <span class="doctag">@param</span> parent the parent class loader</span></span><br><span class="line"><span class="comment">52     */</span></span><br><span class="line"><span class="number">53</span>    <span class="function"><span class="keyword">public</span> <span class="title">DexClassLoader</span><span class="params">(String dexPath, String optimizedDirectory,</span></span></span><br><span class="line"><span class="params"><span class="function"><span class="number">54</span>            String librarySearchPath, ClassLoader parent)</span> </span>{</span><br><span class="line"><span class="number">55</span>        <span class="keyword">super</span>(dexPath, <span class="keyword">null</span>, librarySearchPath, parent);</span><br><span class="line"><span class="number">56</span>    }</span><br><span class="line"><span class="number">57</span>}</span><br></pre></td></tr></table></figure>

<p>å…¶æ„é€ å‡½æ•°éœ€è¦å››ä¸ªå‚æ•°ï¼Œç¬¬ä¸€ä¸ªå‚æ•°æ˜¯åŒ…å«èµ„æºæ–‡ä»¶çš„jar/apk/dexç­‰æ–‡ä»¶çš„è·¯å¾„ï¼Œå¦‚æœæœ‰å¤šä¸ªè·¯å¾„ï¼Œé€šè¿‡:åˆ†éš”ã€‚ç¬¬äºŒä¸ªå‚æ•°å·²ç»åºŸå¼ƒã€‚ç¬¬ä¸‰ä¸ªå‚æ•°ä¸ºnativeåº“çš„è·¯å¾„ï¼Œè¿™é‡Œæˆ‘ä»¬ä¹Ÿæ˜¯ç½®ä¸ºnullã€‚æœ€åä¸€ä¸ªæ˜¯parentç±»åŠ è½½å™¨ï¼Œæˆ‘ä»¬è®¾ç½®ä¸ºå½“å‰ç±»åŠ è½½å™¨å³å¯ã€‚</p>
<p>å› ä¸ºç”¨åˆ°å¯¹sdcardçš„è¯»å†™ï¼Œæ‰€ä»¥éœ€è¦åœ¨AndroidManifest.xmlä¸­æ·»åŠ ç›¸åº”çš„æƒé™ï¼š</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">uses-permission</span> <span class="attr">android:name</span>=<span class="string">"android.permission.READ_EXTERNAL_STORAGE"</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">uses-permission</span> <span class="attr">android:name</span>=<span class="string">"android.permission.WRITE_EXTERNAL_STORAGE"</span> <span class="attr">android:maxSdkVersion</span>=<span class="string">"28"</span> /&gt;</span></span><br></pre></td></tr></table></figure>



<p>è¿è¡Œç¨‹åºï¼Œç»“æœå¦‚ä¸‹ï¼š</p>
<p><img lazyload="" src="/images/loading.svg" data-src="https://img.heshipeng.com/202201131409909.png?watermark/2/text/5YWz5rOo5b6u5L-h5YWs5LyX5Y-377ya6YCG5ZCR5LiA5q2l5q2l/font/5a6L5L2T/fontsize/300" alt="image"></p>
<h3 id="è§£å†³ç¬¬äºŒä¸ªé—®é¢˜"><a href="#è§£å†³ç¬¬äºŒä¸ªé—®é¢˜" class="headerlink" title="è§£å†³ç¬¬äºŒä¸ªé—®é¢˜"></a>è§£å†³ç¬¬äºŒä¸ªé—®é¢˜</h3><p>å¦‚æœä¸è€ƒè™‘åŒäº²å§”æ´¾ä»¥åŠActivityç”Ÿå‘½å‘¨æœŸçš„é—®é¢˜ï¼Œæˆ‘ä»¬æ˜¯ä¸æ˜¯å¯ä»¥ç”¨ç±»ä¼¼äºç¬¬ä¸€ä¸ªé—®é¢˜çš„è§£å†³æ–¹æ¡ˆï¼Œé‡‡ç”¨DexClassLoaderåŠ è½½Activityç±»ï¼Œç„¶åä½¿ç”¨Intentç›´æ¥è®¿é—®è¿™ä¸ªActivityå‘¢ï¼Ÿè¯´å¹²å°±å¹²ã€‚</p>
<ol>
<li>ç”Ÿæˆä¸€ä¸ªç”¨æ¥æµ‹è¯•çš„dex</li>
</ol>
<p>æ–°å»ºä¸€ä¸ªTestActivityæ–‡ä»¶ï¼Œç„¶åè®©TestActivityç»§æ‰¿AppCompatActivtyï¼Œå¹¶é‡å†™onCreateæ–¹æ³•ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TestActivity</span> <span class="keyword">extends</span> <span class="title">AppCompatActivity</span> </span>{</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(<span class="meta">@Nullable</span> Bundle savedInstanceState)</span> </span>{</span><br><span class="line">        <span class="keyword">super</span>.onCreate(savedInstanceState);</span><br><span class="line">        Log.d(<span class="string">"TestActivity"</span>, <span class="string">"i am from TestActivity.onCreate"</span>);</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></table></figure>

<p>è¿™ä¸ªæ–¹æ³•æ¯”è¾ƒç®€å•ï¼Œä»…ä»…æ˜¯æ‰“å°ä¸€æ¡æ—¥å¿—ã€‚</p>
<p>åŒæ ·åœ°ï¼Œæ‰“åŒ…è¯¥é¡¹ç›®ï¼Œå°†ç”Ÿæˆçš„apkè§£å‹ï¼Œå¾—åˆ°dexæ–‡ä»¶ï¼Œç„¶åå°†è¿™ä¸ªclasses.dexæ”¾åˆ°æ‰‹æœºçš„å†…å­˜å¡ã€‚</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">adb push classes3.dex /sdcard/</span><br></pre></td></tr></table></figure>



<ol start="2">
<li>åŠ è½½å¹¶å¯åŠ¨Activity</li>
</ol>
<p>ç¼–è¾‘DexClassLoaderï¼Œä¿®æ”¹MainActivityä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MainActivity</span> <span class="keyword">extends</span> <span class="title">AppCompatActivity</span> </span>{</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(Bundle savedInstanceState)</span> </span>{</span><br><span class="line">        <span class="keyword">super</span>.onCreate(savedInstanceState);</span><br><span class="line">        setContentView(R.layout.activity_main);</span><br><span class="line">        String sdcardPath = Environment.getExternalStorageDirectory().getAbsolutePath();</span><br><span class="line">        startActivityTest(<span class="keyword">this</span>, sdcardPath + File.separator + <span class="string">"classes3.dex"</span>);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">startActivityTest</span><span class="params">(Context context, String dexFilePath)</span> </span>{</span><br><span class="line">        Class&lt;?&gt; clazz = <span class="keyword">null</span>;</span><br><span class="line">        DexClassLoader dexClassLoader = <span class="keyword">new</span> DexClassLoader(dexFilePath, <span class="keyword">null</span>, <span class="keyword">null</span>, MainActivity.class.getClassLoader());</span><br><span class="line">        <span class="keyword">try</span> {</span><br><span class="line">            clazz = dexClassLoader.loadClass(<span class="string">"com.example.dexclass.TestActivity"</span>);</span><br><span class="line">        } <span class="keyword">catch</span> (ClassNotFoundException e) {</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        }</span><br><span class="line">        context.startActivity(<span class="keyword">new</span> Intent(context, clazz));</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></table></figure>



<p>å› ä¸ºæœ‰ç”¨åˆ°<code>TestActivity</code>ï¼Œæ‰€ä»¥éœ€è¦åœ¨AndroidManifest.xmlä¸­å£°æ˜ï¼š</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">activity</span> <span class="attr">android:name</span>=<span class="string">"com.example.dexclass.TestActivity"</span>/&gt;</span></span><br></pre></td></tr></table></figure>



<p>è¿è¡Œé¡¹ç›®ï¼Œåœ¨æ‰‹æœºè®¾ç½®ä¸­ç»™åº”ç”¨å¼€å¯sdcardè¯»å†™æƒé™ï¼Œç„¶åé‡æ–°æ‰§è¡Œï¼Œç»“æœæŠ¥é”™ï¼š</p>
<p><img lazyload="" src="/images/loading.svg" data-src="https://img.heshipeng.com/202201131612910.png?watermark/2/text/5YWz5rOo5b6u5L-h5YWs5LyX5Y-377ya6YCG5ZCR5LiA5q2l5q2l/font/5a6L5L2T/fontsize/300" alt="æ‰§è¡Œç»“æœ"></p>
<p>æƒ³æƒ³ä¹Ÿä¸å¯èƒ½æˆåŠŸï¼Œè¦æ˜¯èƒ½è·Ÿé—®é¢˜ä¸€ä¸€æ ·è§£å†³ï¼Œé‚£è¿˜å«ä¸¤ä¸ªé—®é¢˜å—ğŸ¤ª</p>
<p>é‚£è¯¥å¦‚ä½•è§£å†³ç¬¬äºŒä¸ªé—®é¢˜å‘¢ï¼Ÿæ­¤æ—¶å°±å¾—ä»Activityçš„å¯åŠ¨æµç¨‹è¯´èµ·äº†ï¼Œä½†æ˜¯è¿™ç¯‡æ–‡ç« çš„ç›®çš„è¿˜æ˜¯ä»¥åŠ¨æ€åŠ è½½ä¸ºä¸»ï¼ŒActivityä»¥åŠAppçš„å¯åŠ¨æµç¨‹ä¼šæœ‰ä¸“é—¨çš„æ–‡ç« å»ä»‹ç»ï¼Œæœ¬æ–‡æœ€åç»™å‡ºçš„å‚è€ƒé“¾æ¥ï¼Œä¹Ÿä¼šæœ‰åŒ…å«Activityå¯åŠ¨æµç¨‹çš„ä»‹ç»ã€‚è¿™é‡ŒæŒ‘å‡ ä¸ªå…³é”®é“¾è·¯ä¸Šçš„å‡½æ•°ç®€å•è¯´ä¸‹åŸç†ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**  Core implementation of activity launch. */</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> Activity <span class="title">performLaunchActivity</span><span class="params">(ActivityClientRecord r, Intent customIntent)</span> </span>{</span><br><span class="line">    ActivityInfo aInfo = r.activityInfo;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (r.packageInfo == <span class="keyword">null</span>) {</span><br><span class="line">        r.packageInfo = getPackageInfo(aInfo.applicationInfo, r.compatInfo,</span><br><span class="line">                Context.CONTEXT_INCLUDE_CODE);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">  </span><br><span class="line">    Activity activity = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">try</span> {</span><br><span class="line">        </span><br><span class="line">        java.lang.ClassLoader cl = appContext.getClassLoader();</span><br><span class="line">        activity = mInstrumentation.newActivity(</span><br><span class="line">                cl, component.getClassName(), r.intent);</span><br><span class="line">        StrictMode.incrementExpectedActivityCount(activity.getClass());</span><br><span class="line">        r.intent.setExtrasClassLoader(cl);</span><br><span class="line">        r.intent.prepareToEnterProcess();</span><br><span class="line">        <span class="keyword">if</span> (r.state != <span class="keyword">null</span>) {</span><br><span class="line">            r.state.setClassLoader(cl);</span><br><span class="line">        }</span><br><span class="line">    } <span class="keyword">catch</span> (Exception e) {</span><br><span class="line">        <span class="keyword">if</span> (!mInstrumentation.onException(activity, e)) {</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(</span><br><span class="line">                <span class="string">"Unable to instantiate activity "</span> + component</span><br><span class="line">                + <span class="string">": "</span> + e.toString(), e);</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    <span class="keyword">return</span> activity;</span><br><span class="line">}</span><br></pre></td></tr></table></figure>

<p>çœ‹æ³¨é‡Šå°±çŸ¥é“ï¼Œè¿™ä¸ªæ–¹æ³•æ˜¯å¯åŠ¨Activityçš„æ ¸å¿ƒæ–¹æ³•ï¼Œåœ¨å¯åŠ¨Activityä¹‹å‰ä¼šé€šè¿‡è°ƒç”¨<code>getPackageInfo</code>æ–¹æ³•æ¥å…ˆè·å–å¹¶è§£æActivityä¿¡æ¯ï¼Œæˆ‘ä»¬è¿›åˆ°è¿™ä¸ªæ–¹æ³•ä¸­ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> LoadedApk <span class="title">getPackageInfo</span><span class="params">(ApplicationInfo ai, CompatibilityInfo compatInfo,</span></span></span><br><span class="line"><span class="params"><span class="function">                                      <span class="keyword">int</span> flags)</span> </span>{</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">  <span class="keyword">return</span> getPackageInfo(ai, compatInfo, <span class="keyword">null</span>, securityViolation, includeCode,</span><br><span class="line">                        registerPackage);</span><br><span class="line">}</span><br></pre></td></tr></table></figure>

<p>  è¿™ä¸ªä¸‰ä¸ªå‚æ•°çš„<code>getPackageInfo</code>è°ƒç”¨äº†äº”ä¸ªå‚æ•°çš„<code>getPackageInfo</code>æ–¹æ³•ï¼Œæ³¨æ„ç¬¬ä¸‰ä¸ªå‚æ•°ä¼ çš„æ˜¯<code>null</code>ï¼Œæˆ‘ä»¬ç»§ç»­è¿›å…¥äº”ä¸ªå‚æ•°çš„<code>getPackageInfo</code>æ–¹æ³•ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> LoadedApk <span class="title">getPackageInfo</span><span class="params">(ApplicationInfo aInfo, CompatibilityInfo compatInfo,</span></span></span><br><span class="line"><span class="params"><span class="function">        ClassLoader baseLoader, <span class="keyword">boolean</span> securityViolation, <span class="keyword">boolean</span> includeCode,</span></span></span><br><span class="line"><span class="params"><span class="function">        <span class="keyword">boolean</span> registerPackage)</span> </span>{</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">boolean</span> differentUser = (UserHandle.myUserId() != UserHandle.getUserId(aInfo.uid));</span><br><span class="line">    <span class="keyword">synchronized</span> (mResourcesManager) {</span><br><span class="line">        WeakReference&lt;LoadedApk&gt; ref;</span><br><span class="line">        <span class="keyword">if</span> (differentUser) {</span><br><span class="line">            <span class="comment">// Caching not supported across users</span></span><br><span class="line">            ref = <span class="keyword">null</span>;</span><br><span class="line">        } <span class="keyword">else</span> <span class="keyword">if</span> (includeCode) {</span><br><span class="line">            ref = mPackages.get(aInfo.packageName);</span><br><span class="line">        } <span class="keyword">else</span> {</span><br><span class="line">            ref = mResourcePackages.get(aInfo.packageName);</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">        LoadedApk packageInfo = ref != <span class="keyword">null</span> ? ref.get() : <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">if</span> (packageInfo == <span class="keyword">null</span> || (packageInfo.mResources != <span class="keyword">null</span></span><br><span class="line">                &amp;&amp; !packageInfo.mResources.getAssets().isUpToDate())) {</span><br><span class="line">            <span class="keyword">if</span> (localLOGV) Slog.v(TAG, (includeCode ? <span class="string">"Loading code package "</span></span><br><span class="line">                    : <span class="string">"Loading resource-only package "</span>) + aInfo.packageName</span><br><span class="line">                    + <span class="string">" (in "</span> + (mBoundApplication != <span class="keyword">null</span></span><br><span class="line">                            ? mBoundApplication.processName : <span class="keyword">null</span>)</span><br><span class="line">                    + <span class="string">")"</span>);</span><br><span class="line">            packageInfo =</span><br><span class="line">                <span class="keyword">new</span> LoadedApk(<span class="keyword">this</span>, aInfo, compatInfo, baseLoader,</span><br><span class="line">                        securityViolation, includeCode &amp;&amp;</span><br><span class="line">                        (aInfo.flags&amp;ApplicationInfo.FLAG_HAS_CODE) != <span class="number">0</span>, registerPackage);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (mSystemThread &amp;&amp; <span class="string">"android"</span>.equals(aInfo.packageName)) {</span><br><span class="line">                packageInfo.installSystemApplicationInfo(aInfo,</span><br><span class="line">                        getSystemContext().mPackageInfo.getClassLoader());</span><br><span class="line">            }</span><br><span class="line"></span><br><span class="line">            <span class="comment">// ...</span></span><br><span class="line">        }</span><br><span class="line">        <span class="keyword">return</span> packageInfo;</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></table></figure>

<p>æœ‰ä¸€ä¸ªHashMapå³mPackagesç»´æŠ¤åŒ…åå’ŒLoadedApkçš„å¯¹åº”å…³ç³»ï¼Œå³æ¯ä¸€ä¸ªåº”ç”¨æœ‰ä¸€ä¸ªé”®å€¼å¯¹å¯¹åº”ï¼Œå¦‚æœä¸ºnullï¼Œå°±æ–°åˆ›å»ºä¸€ä¸ªLoadedApkå¯¹è±¡ï¼Œå¹¶å°†å…¶æ·»åŠ åˆ°Mapä¸­ã€‚ç¬¬ä¸€æ¬¡æ‰§è¡ŒActivityçš„æ—¶å€™ï¼Œå¾ˆæ˜¾ç„¶æ˜¯æ²¡æœ‰è¿™ä¸ªLoadedApkå¯¹è±¡çš„ï¼Œæ‰€ä»¥ä¼šç”Ÿæˆä¸€ä¸ªæ–°çš„LoadedApkå¯¹è±¡ï¼Œç„¶åæ³¨æ„åˆ°ä¼ å…¥äº†ä¸€ä¸ªbaseLoaderï¼Œæ­£æ˜¯ä¸Šé¢ä¼ çš„<code>null</code>ã€‚</p>
<p>æˆ‘ä»¬å†å›å¤´çœ‹ä¸‹<code>performLaunchActivity</code>ï¼Œå½“è°ƒç”¨å®Œ<code>getPackageInfo</code>ä¹‹åï¼Œä¼šè°ƒç”¨<code>java.lang.ClassLoader cl = appContext.getClassLoader();</code>å»è·å–<code>classLoader</code>ï¼Œæˆ‘ä»¬è¿›åˆ°<code>ContextImpl.getClassLoader</code>æ–¹æ³•ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> ClassLoader <span class="title">getClassLoader</span><span class="params">()</span> </span>{</span><br><span class="line">        <span class="keyword">return</span> mClassLoader != <span class="keyword">null</span> ? mClassLoader : (mPackageInfo != <span class="keyword">null</span> ? mPackageInfo.getClassLoader() : ClassLoader.getSystemClassLoader());</span><br><span class="line">    }</span><br></pre></td></tr></table></figure>

<p>è¿™é‡Œçš„<code>mClassLoader</code>æ­£æ˜¯ä¸Šé¢ä¼ å…¥çš„<code>null</code>ï¼Œè€Œ<code>mPackageInfo</code>æ˜¯ä¸Šè¾¹ç”Ÿæˆçš„<code>LoadedApk</code>å¯¹è±¡ä¸ä¸ºç©ºï¼Œæ‰€ä»¥ä¼šè°ƒç”¨<code>LoadedApk</code>çš„<code>getClassLoader</code>æ–¹æ³•ã€‚è¿™é‡Œå°±ä¸åœ¨ä¸€å±‚ä¸€å±‚çš„å‰¥å¼€äº†ï¼Œå› ä¸ºæƒ³èŠ‚çœç‚¹ç¬”è¿¹ğŸ¤ªï¼Œæ€»ä¹‹ï¼Œç¿»æºç åˆ°æœ€åï¼Œä½ ä¼šå‘ç°æœ€ç»ˆæ˜¯é€šè¿‡è°ƒç”¨<code>ClassLoader.getSystemClassLoader</code>æ¥è·å–ä¸€ä¸ª<code>classLoader</code>ï¼Œè€Œè¿™ä¸ª<code>classLoader</code>æ­£å¥½æ˜¯<code>PathClassLoader</code>ã€‚</p>
<p>åˆ°è¿™é‡Œä¸€åˆ‡çœŸç›¸å¤§ç™½äº†å§ï¼Ÿå‰é¢**æˆ‘ä»¬è™½ç„¶ç”¨<code>DexClassLoader</code>é€šè¿‡å¯¹APKçš„åŠ¨æ€åŠ è½½æˆåŠŸåŠ è½½äº†<code>TestActivity</code>åˆ°è™šæ‹Ÿæœºï¼Œä½†æ˜¯å½“ç³»ç»Ÿå¯åŠ¨è¯¥<code>Activity</code>çš„æ—¶å€™ï¼Œä¾ç„¶ä¼šå‡ºç°åŠ è½½ç±»å¤±è´¥çš„å¼‚å¸¸ï¼Œå› ä¸º<code>Activity</code>åœ¨å¯åŠ¨æ—¶ç”¨åˆ°çš„æ˜¯<code>PathClassLoader</code>**ã€‚å‰é¢åœ¨ä»‹ç»<code>Android</code>çš„<code>ClassLoader</code>çš„æ—¶å€™æåˆ°è¿‡ï¼Œ<code>PathClassLoader</code>æ˜¯<code>Android</code>é»˜è®¤ä½¿ç”¨çš„ç±»åŠ è½½å™¨ï¼Œä¸€ä¸ª<code>APK</code>ä¸­çš„<code>Activity</code>ç­‰ç±»ä¾¿æ˜¯åœ¨å…¶ä¸­åŠ è½½ï¼Œä½†æ˜¯æˆ‘ä»¬çš„<code>TestActivity</code>ä¸å­˜åœ¨äºå½“å‰çš„<code>APK</code>ï¼Œè€Œæ˜¯åœ¨å¤–éƒ¨çš„<code>dex</code>æ–‡ä»¶ä¸Šï¼Œè‡ªç„¶è€Œç„¶çš„å°±ä¼šå‡ºç°ä¸Šè¾¹æ‰¾ä¸åˆ°<code>Activity</code>çš„å¼‚å¸¸äº†ã€‚</p>
<p>é‚£æˆ‘ä»¬æ˜¯ä¸æ˜¯å¯ä»¥æ›¿æ¢æ‰è¿™ä¸ª<code>PathClassLoader</code>ä¸º<code>DexClassLoader</code>ä¸å°±å¥½äº†å—ï¼Ÿç­”æ¡ˆæ˜¯è‚¯å®šçš„ã€‚é™¤äº†è¿™ä¸ªæ–¹æ¡ˆä¹‹å¤–ï¼Œæˆ‘ä»¬è¿˜å¯ä»¥åˆ©ç”¨åŒäº²å§”æ´¾çš„åŸç†ï¼Œç»™å‡ºå¦ä¸€ç§æ–¹æ¡ˆã€‚ä¸¤ç§è§£å†³æ–¹æ¡ˆå¦‚ä¸‹ï¼š</p>
<ul>
<li>æ›¿æ¢ç³»ç»Ÿç»„ä»¶ç±»åŠ è½½å™¨ä¸ºæˆ‘ä»¬çš„<code>DexClassLoader</code>ï¼ŒåŒæ—¶è®¾ç½®<code>DexClassLoader</code>çš„<code>parent</code>ä¸ºç³»ç»Ÿç»„ä»¶çš„ç±»åŠ è½½å™¨ã€‚</li>
<li>æ‰“ç ´åŸæœ‰çš„åŒäº²å…³ç³»ï¼Œåœ¨ç³»ç»Ÿç»„ä»¶ç±»åŠ è½½å™¨å’Œ<code>BootClassLoader</code>ä¸­æ’å…¥æˆ‘ä»¬è‡ªå·±çš„<code>DexClassLoader</code>å³å¯ã€‚</li>
</ul>
<h4 id="æ–¹æ¡ˆä¸€ï¼šæ›¿æ¢mClassLoaderä¸ºDexClassLoader"><a href="#æ–¹æ¡ˆä¸€ï¼šæ›¿æ¢mClassLoaderä¸ºDexClassLoader" class="headerlink" title="æ–¹æ¡ˆä¸€ï¼šæ›¿æ¢mClassLoaderä¸ºDexClassLoader"></a>æ–¹æ¡ˆä¸€ï¼šæ›¿æ¢<code>mClassLoader</code>ä¸º<code>DexClassLoader</code></h4><p><img lazyload="" src="/images/loading.svg" data-src="https://img.heshipeng.com/202201152137281.png?watermark/2/text/5YWz5rOo5b6u5L-h5YWs5LyX5Y-377ya6YCG5ZCR5LiA5q2l5q2l/font/5a6L5L2T/fontsize/300" alt="image-20220115213655318">ä¿®æ”¹<code>MainActivity</code>çš„ä»£ç å¦‚ä¸‹ï¼š</p>
  <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MainActivity</span> <span class="keyword">extends</span> <span class="title">AppCompatActivity</span> </span>{</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(Bundle savedInstanceState)</span> </span>{</span><br><span class="line">        <span class="keyword">super</span>.onCreate(savedInstanceState);</span><br><span class="line">        setContentView(R.layout.activity_main);</span><br><span class="line">        String sdcardPath = Environment.getExternalStorageDirectory().getAbsolutePath();</span><br><span class="line">        startActivityTest(<span class="keyword">this</span>, sdcardPath + File.separator + <span class="string">"classes3.dex"</span>);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">replaceClassLoader</span><span class="params">(ClassLoader classLoader)</span> </span>{</span><br><span class="line">        <span class="keyword">try</span> {</span><br><span class="line">            <span class="comment">// åŠ è½½ActivityThreadç±»</span></span><br><span class="line">            Class&lt;?&gt; ActivityThreadClazz = classLoader.loadClass(<span class="string">"android.app.ActivityThread"</span>);</span><br><span class="line">            <span class="comment">// è·å–currentActivityThreadæ–¹æ³•,ä»è€Œè·å–ActivityThreadå®ä¾‹</span></span><br><span class="line">            Method currentActivityThreadMethod = ActivityThreadClazz.getDeclaredMethod(<span class="string">"currentActivityThread"</span>);</span><br><span class="line">            currentActivityThreadMethod.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">            Object activityThreadObj = currentActivityThreadMethod.invoke(<span class="keyword">null</span>);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// è·å–ActivityThreadçš„mPackageå±æ€§</span></span><br><span class="line">            Field mPackageField = ActivityThreadClazz.getDeclaredField(<span class="string">"mPackages"</span>);</span><br><span class="line">            mPackageField.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">            <span class="comment">// è·å–loadedApkå¯¹è±¡</span></span><br><span class="line">            ArrayMap mPackageObj = (ArrayMap) mPackageField.get(activityThreadObj);</span><br><span class="line">            WeakReference wr = (WeakReference) mPackageObj.get(<span class="keyword">this</span>.getPackageName());</span><br><span class="line">            Object loadedApkObj = wr.get();</span><br><span class="line"></span><br><span class="line">            <span class="comment">// æ›¿æ¢mClassLoader</span></span><br><span class="line">            Class loadedApkClazz = classLoader.loadClass(<span class="string">"android.app.LoadedApk"</span>);</span><br><span class="line">            Field mClassLoader = loadedApkClazz.getDeclaredField(<span class="string">"mClassLoader"</span>);</span><br><span class="line">            mClassLoader.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">            mClassLoader.set(loadedApkObj, classLoader);</span><br><span class="line">        } <span class="keyword">catch</span> (ClassNotFoundException | NoSuchMethodException e) {</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        } <span class="keyword">catch</span> (IllegalAccessException e) {</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        } <span class="keyword">catch</span> (InvocationTargetException e) {</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        } <span class="keyword">catch</span> (NoSuchFieldException e) {</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">startActivityTest</span><span class="params">(Context context, String dexFilePath)</span> </span>{</span><br><span class="line">        Class&lt;?&gt; clazz = <span class="keyword">null</span>;</span><br><span class="line">        DexClassLoader dexClassLoader = <span class="keyword">new</span> DexClassLoader(dexFilePath, <span class="keyword">null</span>, <span class="keyword">null</span>, MainActivity.class.getClassLoader());</span><br><span class="line">        <span class="keyword">try</span> {</span><br><span class="line">            replaceClassLoader(dexClassLoader);</span><br><span class="line">            clazz = dexClassLoader.loadClass(<span class="string">"com.example.dexclass.TestActivity"</span>);</span><br><span class="line">        } <span class="keyword">catch</span> (ClassNotFoundException e) {</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        }</span><br><span class="line">        context.startActivity(<span class="keyword">new</span> Intent(context, clazz));</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></table></figure>

<p>è¿è¡Œé¡¹ç›®ï¼Œç»“æœå¦‚é¢„æœŸï¼š</p>
<p><img lazyload="" src="/images/loading.svg" data-src="https://img.heshipeng.com/202201152139770.png?watermark/2/text/5YWz5rOo5b6u5L-h5YWs5LyX5Y-377ya6YCG5ZCR5LiA5q2l5q2l/font/5a6L5L2T/fontsize/300" alt="image-20220115213932649"></p>
<h4 id="æ–¹æ¡ˆäºŒï¼šåœ¨mClassLoaderå’ŒBootClassLoaderä¹‹é—´æ’å…¥DexClassLoader"><a href="#æ–¹æ¡ˆäºŒï¼šåœ¨mClassLoaderå’ŒBootClassLoaderä¹‹é—´æ’å…¥DexClassLoader" class="headerlink" title="æ–¹æ¡ˆäºŒï¼šåœ¨mClassLoaderå’ŒBootClassLoaderä¹‹é—´æ’å…¥DexClassLoader"></a>æ–¹æ¡ˆäºŒï¼šåœ¨<code>mClassLoader</code>å’Œ<code>BootClassLoader</code>ä¹‹é—´æ’å…¥<code>DexClassLoader</code></h4><p><img lazyload="" src="/images/loading.svg" data-src="https://img.heshipeng.com/202201152147745.png?watermark/2/text/5YWz5rOo5b6u5L-h5YWs5LyX5Y-377ya6YCG5ZCR5LiA5q2l5q2l/font/5a6L5L2T/fontsize/300" alt="image-20220115214708638"></p>
<p>ä¿®æ”¹<code>TestActivity</code>ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TestActivity</span> <span class="keyword">extends</span> <span class="title">Activity</span> </span>{</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(<span class="meta">@Nullable</span> Bundle savedInstanceState)</span> </span>{</span><br><span class="line">        <span class="keyword">super</span>.onCreate(savedInstanceState);</span><br><span class="line">        Log.d(<span class="string">"TestActivity"</span>, <span class="string">"i am from TestActivity.onCreate"</span>);</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></table></figure>

<p>æŠŠ<code>AppCompatActivity</code>æ”¹ä¸ºäº†<code>Activity</code>ï¼Œé˜²æ­¢æœ‰ä¸€äº›ç±»é‡å¤åŠ è½½ã€‚</p>
<p>å†æ¬¡ä¿®æ”¹<code>MainActivity</code>çš„ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MainActivity</span> <span class="keyword">extends</span> <span class="title">Activity</span> </span>{</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(Bundle savedInstanceState)</span> </span>{</span><br><span class="line">        <span class="keyword">super</span>.onCreate(savedInstanceState);</span><br><span class="line">        setContentView(R.layout.activity_main);</span><br><span class="line">        String sdcardPath = Environment.getExternalStorageDirectory().getAbsolutePath();</span><br><span class="line">        startActivityTest(<span class="keyword">this</span>, sdcardPath + File.separator + <span class="string">"classes3.dex"</span>);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">startActivityTest</span><span class="params">(Context context, String dexFilePath)</span> </span>{</span><br><span class="line">        Class&lt;?&gt; clazz = <span class="keyword">null</span>;</span><br><span class="line">        ClassLoader pathClassLoader = MainActivity.class.getClassLoader();</span><br><span class="line">        ClassLoader bootClassLoader = MainActivity.class.getClassLoader().getParent();</span><br><span class="line">        <span class="comment">// dexClassLoaderçš„parentä¸ºBootClassLoader</span></span><br><span class="line">        DexClassLoader dexClassLoader = <span class="keyword">new</span> DexClassLoader(dexFilePath, <span class="keyword">null</span>, <span class="keyword">null</span>, bootClassLoader);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> {</span><br><span class="line">            Field parentField = ClassLoader.class.getDeclaredField(<span class="string">"parent"</span>);</span><br><span class="line">            parentField.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">            <span class="comment">// å½“å‰ç»„ä»¶çš„ClassLoaderçš„parentä¸ºDexClassLoader</span></span><br><span class="line">            parentField.set(pathClassLoader, dexClassLoader);</span><br><span class="line">            clazz = dexClassLoader.loadClass(<span class="string">"com.example.dexclass.TestActivity"</span>);</span><br><span class="line">        } <span class="keyword">catch</span> (ClassNotFoundException | NoSuchFieldException e) {</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        } <span class="keyword">catch</span> (IllegalAccessException e) {</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        }</span><br><span class="line">        context.startActivity(<span class="keyword">new</span> Intent(context, clazz));</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></table></figure>

<p>è¿è¡Œé¡¹ç›®ï¼Œç»“æœä¹Ÿå¦‚é¢„æœŸï¼š</p>
<p><img lazyload="" src="/images/loading.svg" data-src="https://img.heshipeng.com/202201152315708.png?watermark/2/text/5YWz5rOo5b6u5L-h5YWs5LyX5Y-377ya6YCG5ZCR5LiA5q2l5q2l/font/5a6L5L2T/fontsize/300" alt="image-20220115231522507"></p>
<h3 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h3><p>åŠ¨æ€åŠ è½½å°±æ˜¯ç”¨åˆ°çš„æ—¶å€™å†å»åŠ è½½ï¼Œä¹Ÿå«æ‡’åŠ è½½ï¼Œä¹Ÿå°±æ„å‘³ç€ç”¨ä¸åˆ°çš„æ—¶å€™æ˜¯ä¸ä¼šå»åŠ è½½çš„ã€‚åŠ¨æ€åŠ è½½æ˜¯dexåŠ å£³ï¼Œæ’ä»¶åŒ–ï¼Œçƒ­æ›´æ–°çš„åŸºç¡€ã€‚åŠ¨æ€åŠ è½½çš„dexä¸å…·æœ‰ç”Ÿå‘½å‘¨æœŸç‰¹å¾ï¼ŒAppä¸­çš„Activity, Serviceç­‰ç»„ä»¶æ— æ³•æ­£å¸¸å·¥ä½œï¼Œåªèƒ½å®Œæˆä¸€èˆ¬å‡½æ•°çš„è°ƒç”¨ï¼›éœ€è¦å¯¹ClassLoaderè¿›è¡Œä¿®æ­£ï¼ŒAppæ‰èƒ½æ­£å¸¸è¿è¡Œï¼Œä¸¤ç§ä¿®æ­£æ–¹æ¡ˆï¼š</p>
<ol>
<li>æ›¿æ¢ç³»ç»Ÿç»„ä»¶ç±»åŠ è½½å™¨ä¸ºæˆ‘ä»¬çš„<code>DexClassLoader</code>ï¼ŒåŒæ—¶è®¾ç½®<code>DexClassLoader</code>çš„<code>parent</code>ä¸ºç³»ç»Ÿç»„ä»¶çš„ç±»åŠ è½½å™¨ã€‚</li>
<li>æ‰“ç ´åŸæœ‰çš„åŒäº²å…³ç³»ï¼Œåœ¨ç³»ç»Ÿç»„ä»¶ç±»åŠ è½½å™¨å’Œ<code>BootClassLoader</code>ä¸­æ’å…¥æˆ‘ä»¬è‡ªå·±çš„<code>DexClassLoader</code>å³å¯ã€‚</li>
</ol>
<h3 id="å‚è€ƒé“¾æ¥"><a href="#å‚è€ƒé“¾æ¥" class="headerlink" title="å‚è€ƒé“¾æ¥"></a>å‚è€ƒé“¾æ¥</h3><p><a class="link" target="_blank" rel="noopener" href="https://blog.csdn.net/cauchyweierstrass/article/details/51087198">AndroidåŠ¨æ€åŠ è½½ActivityåŸç†<i class="fas fa-external-link-alt"></i></a></p>
<p><a class="link" target="_blank" rel="noopener" href="https://bbs.pediy.com/thread-252630.htm#msg_header_h2_6">FARTï¼šARTç¯å¢ƒä¸‹åŸºäºä¸»åŠ¨è°ƒç”¨çš„è‡ªåŠ¨åŒ–è„±å£³æ–¹æ¡ˆ<i class="fas fa-external-link-alt"></i></a></p>
<p><a class="link" target="_blank" rel="noopener" href="http://androidxref.com/9.0.0_r3/xref/frameworks/base/core/java/android/app/ActivityThread.java">ActivityThreadæºç <i class="fas fa-external-link-alt"></i></a></p>
<p><a class="link" target="_blank" rel="noopener" href="https://samiu.top/2020/04/16/Activity%E7%9A%84%E5%90%AF%E5%8A%A8%E6%B5%81%E7%A8%8B%E6%8E%A2%E7%A9%B6/">Activityçš„å¯åŠ¨æµç¨‹æ¢ç©¶<i class="fas fa-external-link-alt"></i></a></p>
<p><a class="link" target="_blank" rel="noopener" href="https://segmentfault.com/a/1190000004062880">AndroidåŠ¨æ€åŠ è½½åŸºç¡€ ClassLoaderå·¥ä½œæœºåˆ¶<i class="fas fa-external-link-alt"></i></a></p>

        </div>

        
            <div class="post-copyright-info">
                <div class="article-copyright-info-container">
    <ul>
        <li>æœ¬æ–‡æ ‡é¢˜ï¼šAndroidé€†å‘ä¹‹åŠ¨æ€åŠ è½½</li>
        <li>æœ¬æ–‡ä½œè€…ï¼šShipeng He</li>
        <li>åˆ›å»ºæ—¶é—´ï¼š2022-01-15 23:40:22</li>
        <li>
            æœ¬æ–‡é“¾æ¥ï¼šhttps://blog.heshipeng.com/Androidé€†å‘ä¹‹åŠ¨æ€åŠ è½½/
        </li>
        <li>
            ç‰ˆæƒå£°æ˜ï¼šæœ¬åšå®¢æ‰€æœ‰æ–‡ç« é™¤ç‰¹åˆ«å£°æ˜å¤–ï¼Œå‡é‡‡ç”¨ <a class="license" target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh">BY-NC-SA</a> è®¸å¯åè®®ã€‚è½¬è½½è¯·æ³¨æ˜å‡ºå¤„ï¼
        </li>
    </ul>
</div>

            </div>
        

        
            <ul class="post-tags-box">
                
                    <li class="tag-item">
                        <a href="/tags/%E9%80%86%E5%90%91/">#é€†å‘</a>&nbsp;
                    </li>
                
                    <li class="tag-item">
                        <a href="/tags/android/">#android</a>&nbsp;
                    </li>
                
            </ul>
        

        
            <div class="article-nav">
                
                    <div class="article-prev">
                        <a class="prev"
                           rel="prev"
                           href="/%E4%B8%80%E6%96%87%E4%BA%86%E8%A7%A3Dex%E6%96%87%E4%BB%B6%E6%A0%BC%E5%BC%8F/"
                        >
                            <span class="left arrow-icon flex-center">
                              <i class="fas fa-chevron-left"></i>
                            </span>
                            <span class="title flex-center">
                                <span class="post-nav-title-item">ä¸€æ–‡äº†è§£Dexæ–‡ä»¶æ ¼å¼</span>
                                <span class="post-nav-item">ä¸Šä¸€ç¯‡</span>
                            </span>
                        </a>
                    </div>
                
                
                    <div class="article-next">
                        <a class="next"
                           rel="next"
                           href="/%E5%A4%A7%E7%AB%AF%E8%BF%98%E6%98%AF%E5%B0%8F%E7%AB%AF/"
                        >
                            <span class="title flex-center">
                                <span class="post-nav-title-item">å¤§ç«¯è¿˜æ˜¯å°ç«¯ï¼Ÿ</span>
                                <span class="post-nav-item">ä¸‹ä¸€ç¯‡</span>
                            </span>
                            <span class="right arrow-icon flex-center">
                              <i class="fas fa-chevron-right"></i>
                            </span>
                        </a>
                    </div>
                
            </div>
        

        
            <div class="comment-container">
                <div class="comments-container">
    <div id="comment-anchor"></div>
    <div class="comment-area-title">
        <i class="fas fa-comments">&nbsp;è¯„è®º</i>
    </div>
    

        
            
    <div id="gitalk-container"></div>
    <script 
            src="//cdn.jsdelivr.net/npm/gitalk/dist/gitalk.min.js"></script>
    <script >

        function loadGitalk() {
            let __gitalk__pathname = decodeURI(location.pathname);
            const __gitalk__pathnameLength = __gitalk__pathname.length;
            const __gitalk__pathnameMaxLength = 50;
            if (__gitalk__pathnameLength > __gitalk__pathnameMaxLength) {
                __gitalk__pathname = __gitalk__pathname.substring(0, __gitalk__pathnameMaxLength - 3) + '...';
            }

            try {
                Gitalk && new Gitalk({
                    clientID: '5167adeb62c9c9a59956',
                    clientSecret: '8f4116c8b36633d863779e56e746184d2f795ae4',
                    repo: 'beyond-heshipeng.github.io',
                    owner: 'beyond-heshipeng',
                    admin: ['beyond-heshipeng'],
                    id: __gitalk__pathname,
                    language: 'zh-CN'
                }).render('gitalk-container');

            } catch (e) {
                window.Gitalk = null;
            }
        }

        if ('false') {
            const loadGitalkTimeout = setTimeout(() => {
                loadGitalk();
                clearTimeout(loadGitalkTimeout);
            }, 1000);
        } else {
            window.addEventListener('DOMContentLoaded', loadGitalk);
        }
    </script>



        
    
</div>

            </div>
        
    </div>
</div>


                
            </div>

        </div>

        <div class="page-main-content-bottom">
            <footer class="footer">
    <div class="info-container">
        <div class="copyright-info info-item">
            &copy;
            
              <span>2021</span>
              -
            
            2022&nbsp;<i class="fas fa-heart icon-animate"></i>&nbsp;<a href="/">Shipeng He</a> ç‰ˆæƒæ‰€æœ‰
        </div>
        
            <script async  src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
            <div class="website-count info-item">
                
                    <span id="busuanzi_container_site_uv">
                        è®¿é—®äººæ•°&nbsp;<span id="busuanzi_value_site_uv"></span>&ensp;
                    </span>
                
                
                    <span id="busuanzi_container_site_pv">
                        æ€»è®¿é—®é‡&nbsp;<span id="busuanzi_value_site_pv"></span>
                    </span>
                
            </div>
        
        <div class="theme-info info-item">
        </div>
        
            <div class="icp-info info-item"><a target="_blank" rel="nofollow" href="https://beian.miit.gov.cn">é„‚ICPå¤‡2022001140å·</a></div>
        
        
    </div>
</footer>


        </div>
    </div>

    
        <div class="post-tools">
            <div class="post-tools-container">
    <ul class="tools-list">
        <!-- TOC aside toggle -->
        
            <li class="tools-item page-aside-toggle">
                <i class="fas fa-outdent"></i>
            </li>
        

        <!-- go comment -->
        
            <li class="go-comment">
                <i class="fas fa-comment"></i>
            </li>
        
    </ul>
</div>

        </div>
    

    <div class="right-bottom-side-tools">
        <div class="side-tools-container">
    <ul class="side-tools-list">
        <li class="tools-item tool-font-adjust-plus flex-center">
            <i class="fas fa-search-plus"></i>
        </li>

        <li class="tools-item tool-font-adjust-minus flex-center">
            <i class="fas fa-search-minus"></i>
        </li>

        <li class="tools-item tool-expand-width flex-center">
            <i class="fas fa-arrows-alt-h"></i>
        </li>

        <li class="tools-item tool-dark-light-toggle flex-center">
            <i class="fas fa-moon"></i>
        </li>

        <!-- rss -->
        

        

        <li class="tools-item tool-scroll-to-bottom flex-center">
            <i class="fas fa-arrow-down"></i>
        </li>
    </ul>

    <ul class="exposed-tools-list">
        <li class="tools-item tool-toggle-show flex-center">
            <i class="fas fa-cog fa-spin"></i>
        </li>
        
            <li class="tools-item tool-scroll-to-top flex-center">
                <i class="arrow-up fas fa-arrow-up"></i>
                <span class="percent"></span>
            </li>
        
    </ul>
</div>

    </div>

    
        <aside class="page-aside">
            <div class="post-toc-wrap">
    <div class="post-toc">
        <ol class="nav"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%8A%A8%E6%80%81%E5%8A%A0%E8%BD%BD"><span class="nav-text">åŠ¨æ€åŠ è½½</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%B8%A4%E4%B8%AA%E7%96%91%E9%97%AE%F0%9F%A4%94"><span class="nav-text">ä¸¤ä¸ªç–‘é—®ğŸ¤”</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%B1%BB%E5%8A%A0%E8%BD%BD%E5%99%A8%E4%B8%8E%E5%8F%8C%E4%BA%B2%E5%A7%94%E6%B4%BE"><span class="nav-text">ç±»åŠ è½½å™¨ä¸åŒäº²å§”æ´¾</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%B1%BB%E5%8A%A0%E8%BD%BD%E5%99%A8"><span class="nav-text">ç±»åŠ è½½å™¨</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#JVM%E7%9A%84%E7%B1%BB%E5%8A%A0%E8%BD%BD%E5%99%A8"><span class="nav-text">JVMçš„ç±»åŠ è½½å™¨</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#Android%E4%B8%AD%E7%9A%84%E7%B1%BB%E5%8A%A0%E8%BD%BD%E5%99%A8"><span class="nav-text">Androidä¸­çš„ç±»åŠ è½½å™¨</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E7%B1%BB%E5%8A%A0%E8%BD%BD%E7%9A%84%E6%97%B6%E6%9C%BA"><span class="nav-text">ç±»åŠ è½½çš„æ—¶æœº</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E7%B1%BB%E5%8A%A0%E8%BD%BD%E7%9A%84%E6%AD%A5%E9%AA%A4"><span class="nav-text">ç±»åŠ è½½çš„æ­¥éª¤</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E7%BC%96%E5%86%99%E4%BB%A3%E7%A0%81%E6%B5%8B%E8%AF%95Android-ClassLoader%E7%9A%84%E7%BB%A7%E6%89%BF%E5%85%B3%E7%B3%BB"><span class="nav-text">ç¼–å†™ä»£ç æµ‹è¯•Android ClassLoaderçš„ç»§æ‰¿å…³ç³»</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%8F%8C%E4%BA%B2%E5%A7%94%E6%B4%BE"><span class="nav-text">åŒäº²å§”æ´¾</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#%E5%8F%8C%E4%BA%B2%E5%A7%94%E6%B4%BE%E7%9A%84%E5%B7%A5%E4%BD%9C%E5%8E%9F%E7%90%86"><span class="nav-text">åŒäº²å§”æ´¾çš„å·¥ä½œåŸç†</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E4%B8%BA%E4%BB%80%E4%B9%88%E4%BC%9A%E6%9C%89%E5%8F%8C%E4%BA%B2%E5%A7%94%E6%B4%BE"><span class="nav-text">ä¸ºä»€ä¹ˆä¼šæœ‰åŒäº²å§”æ´¾</span></a></li></ol></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%A7%A3%E5%86%B3%E7%AC%AC%E4%B8%80%E4%B8%AA%E9%97%AE%E9%A2%98"><span class="nav-text">è§£å†³ç¬¬ä¸€ä¸ªé—®é¢˜</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%A7%A3%E5%86%B3%E7%AC%AC%E4%BA%8C%E4%B8%AA%E9%97%AE%E9%A2%98"><span class="nav-text">è§£å†³ç¬¬äºŒä¸ªé—®é¢˜</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%96%B9%E6%A1%88%E4%B8%80%EF%BC%9A%E6%9B%BF%E6%8D%A2mClassLoader%E4%B8%BADexClassLoader"><span class="nav-text">æ–¹æ¡ˆä¸€ï¼šæ›¿æ¢mClassLoaderä¸ºDexClassLoader</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%96%B9%E6%A1%88%E4%BA%8C%EF%BC%9A%E5%9C%A8mClassLoader%E5%92%8CBootClassLoader%E4%B9%8B%E9%97%B4%E6%8F%92%E5%85%A5DexClassLoader"><span class="nav-text">æ–¹æ¡ˆäºŒï¼šåœ¨mClassLoaderå’ŒBootClassLoaderä¹‹é—´æ’å…¥DexClassLoader</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%80%BB%E7%BB%93"><span class="nav-text">æ€»ç»“</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%8F%82%E8%80%83%E9%93%BE%E6%8E%A5"><span class="nav-text">å‚è€ƒé“¾æ¥</span></a></li></ol>
    </div>
</div>
        </aside>
    

    <div class="image-viewer-container">
    <img src="">
</div>


    
        <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
          <span class="search-input-field-pre">
            <i class="fas fa-keyboard"></i>
          </span>
            <div class="search-input-container">
                <input autocomplete="off"
                       autocorrect="off"
                       autocapitalize="off"
                       placeholder="æœç´¢..."
                       spellcheck="false"
                       type="search"
                       class="search-input"
                >
            </div>
            <span class="popup-btn-close">
                <i class="fas fa-times"></i>
            </span>
        </div>
        <div id="search-result">
            <div id="no-result">
                <i class="fas fa-spinner fa-pulse fa-5x fa-fw"></i>
            </div>
        </div>
    </div>
</div>

    

</main>



<script src="//cdn.jsdelivr.net/npm/hexo-theme-keep@3.4.5/source/js/utils.js"></script><script src="//cdn.jsdelivr.net/npm/hexo-theme-keep@3.4.5/source/js/main.js"></script><script src="//cdn.jsdelivr.net/npm/hexo-theme-keep@3.4.5/source/js/header-shrink.js"></script><script src="//cdn.jsdelivr.net/npm/hexo-theme-keep@3.4.5/source/js/back2top.js"></script><script src="//cdn.jsdelivr.net/npm/hexo-theme-keep@3.4.5/source/js/dark-light-toggle.js"></script>


    <script src="//cdn.jsdelivr.net/npm/hexo-theme-keep@3.4.5/source/js/local-search.js"></script>



    <script src="//cdn.jsdelivr.net/npm/hexo-theme-keep@3.4.5/source/js/code-copy.js"></script>



    <script src="//cdn.jsdelivr.net/npm/hexo-theme-keep@3.4.5/source/js/lazyload.js"></script>


<div class="post-scripts">
    
        <script src="//cdn.jsdelivr.net/npm/hexo-theme-keep@3.4.5/source/js/left-side-toggle.js"></script><script src="//cdn.jsdelivr.net/npm/hexo-theme-keep@3.4.5/source/js/libs/anime.min.js"></script><script src="//cdn.jsdelivr.net/npm/hexo-theme-keep@3.4.5/source/js/toc.js"></script>
    
</div>



</body>
</html>
